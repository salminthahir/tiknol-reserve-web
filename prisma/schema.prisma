// 1. Konfigurasi Koneksi (Sudah Benar Sesuai .env Kamu)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// MULTI-BRANCH MODELS
// ============================================

// NEW: Branch Model - Core of multi-branch system
model Branch {
  id              String   @id @default(cuid())
  code            String   @unique // e.g., "JKT-01", "BDG-01"
  name            String   // e.g., "Nol Coffee Jakarta Pusat"
  address         String?
  phone           String?
  
  // Geofencing per branch
  latitude        Float    @default(0)
  longitude       Float    @default(0)
  maxRadius       Float    @default(100) // meter
  
  // Operational status
  isActive        Boolean  @default(true)
  openingHours    Json?    // { "monday": "08:00-22:00", ... }
  
  // Relations
  orders          Order[]
  employees       Employee[]       // Home Branch Employees
  accessibleEmployees EmployeeAccess[] // Employees with specific access
  attendances     Attendance[]
  shifts          Shift[]
  productBranches ProductBranch[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// NEW: ProductBranch - Junction table untuk product availability per branch
model ProductBranch {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  branchId    String
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  isAvailable Boolean  @default(true) // Per-branch availability toggle
  branchPrice Int?     // Optional: override base price untuk branch ini
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([productId, branchId]) // 1 product only 1 record per branch
  @@index([branchId, isAvailable])
}

// ============================================
// UPDATED MODELS (MULTI-BRANCH)
// ============================================

// 2. Model Order (UPDATED)
model Order {
  id           String   @id
 // ID Unik (misal: cmkp...)
  
  // NEW: Branch assignment
  branchId     String
  branch       Branch   @relation(fields: [branchId], references: [id])
  
  // Data Customer
  customerName String
  whatsapp     String
  
  // Data Transaksi
  subtotal     Int?     // Before discount (optional for backward compatibility)
  discountAmount Int    @default(0) // Discount from voucher
  totalAmount  Int      // After discount
  items        Json     // Menyimpan detail menu (nama, qty, harga)
  orderType    String   @default("DINE_IN") // Values: "DINE_IN", "TAKE_AWAY"
  
  // Status Pembayaran & Dapur
  // Values: "PENDING", "PAID", "PREPARING", "READY", "COMPLETED", "FAILED"
  status       String   @default("PENDING") 
  
  // Token Midtrans (Disimpan biar user bisa resume payment)
  snapToken    String?  

  orderSource  String  @default("WEB_CUSTOMER") // Values: "WEB_CUSTOMER", "CASHIER_POS"
  paymentType  String // "CASH", "QRIS", "DEBIT"
  
  // Voucher relation
  voucherId    String?
  voucher      Voucher? @relation(fields: [voucherId], references: [id])
  
  // Waktu
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // NEW: Indexes untuk query performance
  @@index([branchId, status])
  @@index([branchId, createdAt])
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Int      // Base price (bisa di-override per branch)
  image       String?  // URL gambar dari Supabase Storage
  category    String   // Misal: "Coffee", "Non-Coffee", "Snack"
  
  // REMOVED: Global isAvailable (pindah ke ProductBranch)
  // isAvailable Boolean  @default(true) // DEPRECATED - use ProductBranch.isAvailable
  
  // Customization Config
  hasCustomization     Boolean @default(false)
  customizationOptions Json?   // { temps: ['ICE', 'HOT'], sizes: ['REGULAR', 'MEDIUM', 'LARGE'] }

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // NEW: Many-to-many dengan Branch
  productBranches      ProductBranch[]
}

model Shift {
  id           String    @id @default(cuid())
  
  // NEW: Branch assignment
  branchId     String
  branch       Branch    @relation(fields: [branchId], references: [id])
  
  cashierName  String
  startTime    DateTime  @default(now())
  endTime      DateTime? 
  
  startCash    Int       @default(0) // Modal Awal
  expectedCash Int?      // Hitungan Sistem (Start + Sales)
  actualCash   Int?      // Uang Fisik saat closing
  difference   Int?      // Selisih (Actual - Expected)
  
  status       String    @default("OPEN") // OPEN, CLOSED
  
  @@index([branchId, status])
}

// 4. Model Voucher (Sistem Diskon/Promosi) - UPDATED
model Voucher {
  id              String      @id @default(cuid())
  code            String      @unique
  name            String
  description     String?
  type            VoucherType
  value           Float       // Percentage (0-100) or Fixed Amount
  minPurchase     Float       @default(0)
  maxDiscount     Float?      // For percentage type
  usageLimit      Int?        // Total usage limit
  usageCount      Int         @default(0)
  perUserLimit    Int?        // Per customer limit
  validFrom       DateTime
  validUntil      DateTime
  active          Boolean     @default(true)
  applicableItems     Json?       // Array of menu item IDs (optional)
  applicableCategories Json?      // Array of category names (optional)
  
  // NEW: Branch restriction (null = berlaku untuk semua branch)
  applicableBranches   Json?       // Array of branch IDs: ["branch_id_1", "branch_id_2"]
  
  happyHourStart      String?     // e.g., "14:00"
  happyHourEnd        String?     // e.g., "17:00"
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  orders          Order[]
}

enum VoucherType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_ITEM
  BUY_X_GET_Y
}

// 5. Model Karyawan (Attendance System) - UPDATED
model Employee {
  id            String       @id // Manual Sequential ID: EMP-XXX
  
  // NEW: Branch assignment
  branchId      String
  branch        Branch       @relation(fields: [branchId], references: [id])
  
  name          String
  whatsapp      String       @unique
  pin           String?      // Optional 4-digit PIN for extra security
  role          EmployeeRole @default(STAFF)
  deviceId      String?      // Stored device fingerprint
  isActive      Boolean      @default(true)
  
  // NEW: Multi-Branch Access Control
  isGlobalAccess     Boolean          @default(false) // If true, can access ALL branches
  accessibleBranches EmployeeAccess[] // Specific additional branches
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  attendances   Attendance[]
  
  @@index([branchId, role])
}

// NEW: Junction table for Employee-Branch Access
model EmployeeAccess {
  id          String   @id @default(cuid())
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  branchId    String
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  
  @@unique([employeeId, branchId])
  @@index([employeeId])
  @@index([branchId])
}

model Attendance {
  id            String           @id @default(cuid())
  
  // NEW: Branch tracking (denormalized untuk query performance)
  branchId      String
  branch        Branch           @relation(fields: [branchId], references: [id])
  
  employeeId    String
  employee      Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  type          AttendanceType   // CLOCK_IN or CLOCK_OUT
  timestamp     DateTime         @default(now()) // Server time, NOT client time
  photoUrl      String?          // Supabase storage URL
  latitude      Float?
  longitude     Float?
  deviceId      String?          // Device fingerprint at time of punch
  status        AttendanceStatus @default(PENDING)
  notes         String?          // Admin notes for corrections
  createdAt     DateTime         @default(now())
  
  @@index([branchId, timestamp])
  @@index([employeeId, timestamp])
}

enum EmployeeRole {
  STAFF
  MANAGER
  ADMIN
}

enum AttendanceType {
  CLOCK_IN
  CLOCK_OUT
}

enum AttendanceStatus {
  PENDING    // Waiting for admin review (if anomaly detected)
  APPROVED
  REJECTED
  CORRECTED  // Admin made manual adjustment
}

// 6. Model Settings (Config) - DEPRECATED for branch-specific settings
model Settings {
  id              String   @id @default(cuid())
  
  // Global settings only (NOT per-branch)
  adminName       String   @default("Super Admin")
  
  // DEPRECATED: Moved to Branch model
  // storeName       String   @default("Nol Coffee")
  // storeAddress    String?
  // storePhone      String?
  // officeLatitude  Float    @default(0)
  // officeLongitude Float    @default(0)
  // maxRadius       Float    @default(100)
  
  updatedAt       DateTime @updatedAt
}
