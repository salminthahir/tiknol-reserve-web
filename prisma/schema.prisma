// 1. Konfigurasi Koneksi (Sudah Benar Sesuai .env Kamu)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 2. Model Order (CUMA BOLEH ADA SATU)
model Order {
  id           String   @id
 // ID Unik (misal: cmkp...)
  
  // Data Customer
  customerName String
  whatsapp     String
  
  // Data Transaksi
  subtotal     Int?     // Before discount (optional for backward compatibility)
  discountAmount Int    @default(0) // Discount from voucher
  totalAmount  Int      // After discount
  items        Json     // Menyimpan detail menu (nama, qty, harga)
  orderType    String   @default("DINE_IN") // Values: "DINE_IN", "TAKE_AWAY"
  
  // Status Pembayaran & Dapur
  // Values: "PENDING", "PAID", "PREPARING", "READY", "COMPLETED", "FAILED"
  status       String   @default("PENDING") 
  
  // Token Midtrans (Disimpan biar user bisa resume payment)
  snapToken    String?  

  orderSource  String  @default("WEB_CUSTOMER") // Values: "WEB_CUSTOMER", "CASHIER_POS"
  paymentType  String // "CASH", "QRIS", "DEBIT"
  
  // Voucher relation
  voucherId    String?
  voucher      Voucher? @relation(fields: [voucherId], references: [id])
  
  // Waktu
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Int
  image       String?  // URL gambar dari Supabase Storage
  category    String   // Misal: "Coffee", "Non-Coffee", "Snack"
  isAvailable Boolean  @default(true) // Buat switch On/Off stok habis
  
  // Customization Config
  hasCustomization     Boolean @default(false)
  customizationOptions Json?   // { temps: ['ICE', 'HOT'], sizes: ['REGULAR', 'MEDIUM', 'LARGE'] }

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Shift {
  id           String    @id @default(cuid())
  cashierName  String
  startTime    DateTime  @default(now())
  endTime      DateTime? 
  
  startCash    Int       @default(0) // Modal Awal
  expectedCash Int?      // Hitungan Sistem (Start + Sales)
  actualCash   Int?      // Uang Fisik saat closing
  difference   Int?      // Selisih (Actual - Expected)
  
  status       String    @default("OPEN") // OPEN, CLOSED
  
  // Relasi ke Order (Opsional, jika ingin track order masuk shift mana)
  // Untuk fase ini, kita pakai filter by time range saja biar simpel
}

// 4. Model Voucher (Sistem Diskon/Promosi)
model Voucher {
  id              String      @id @default(cuid())
  code            String      @unique
  name            String
  description     String?
  type            VoucherType
  value           Float       // Percentage (0-100) or Fixed Amount
  minPurchase     Float       @default(0)
  maxDiscount     Float?      // For percentage type
  usageLimit      Int?        // Total usage limit
  usageCount      Int         @default(0)
  perUserLimit    Int?        // Per customer limit
  validFrom       DateTime
  validUntil      DateTime
  active          Boolean     @default(true)
  applicableItems     Json?       // Array of menu item IDs (optional)
  applicableCategories Json?      // Array of category names (optional)
  happyHourStart      String?     // e.g., "14:00"
  happyHourEnd        String?     // e.g., "17:00"
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  orders          Order[]
}

enum VoucherType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_ITEM
  BUY_X_GET_Y
}

// 5. Model Karyawan (Attendance System)
model Employee {
  id            String       @id // Manual Sequential ID: EMP-XXX
  name          String
  whatsapp      String       @unique
  pin           String?      // Optional 4-digit PIN for extra security
  role          EmployeeRole @default(STAFF)
  deviceId      String?      // Stored device fingerprint
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  attendances   Attendance[]
}

model Attendance {
  id            String           @id @default(cuid())
  employeeId    String
  employee      Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  type          AttendanceType   // CLOCK_IN or CLOCK_OUT
  timestamp     DateTime         @default(now()) // Server time, NOT client time
  photoUrl      String?          // Supabase storage URL
  latitude      Float?
  longitude     Float?
  deviceId      String?          // Device fingerprint at time of punch
  status        AttendanceStatus @default(PENDING)
  notes         String?          // Admin notes for corrections
  createdAt     DateTime         @default(now())
}

enum EmployeeRole {
  STAFF
  MANAGER
  ADMIN
}

enum AttendanceType {
  CLOCK_IN
  CLOCK_OUT
}

enum AttendanceStatus {
  PENDING    // Waiting for admin review (if anomaly detected)
  APPROVED
  REJECTED
  CORRECTED  // Admin made manual adjustment
}

// 6. Model Settings (Config)
model Settings {
  id              String   @id @default(cuid())
  officeLatitude  Float    @default(0) // Latitude Kantor
  officeLongitude Float    @default(0) // Longitude Kantor
  maxRadius       Float    @default(100) // Radius Absen (meter)
  updatedAt       DateTime @updatedAt
}